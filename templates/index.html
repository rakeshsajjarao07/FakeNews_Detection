<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake News Detector</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header class="navbar">
        <div class="brand">Fake<span>News</span>Detector</div>
        <div class="nav-actions" id="nav-actions">
            <button class="btn ghost" id="btn-signin">Sign In</button>
            <button class="btn primary" id="btn-signup">Sign Up</button>
        </div>
        <div class="nav-user" id="nav-user" style="display:none;">
            <span id="nav-fullname"></span>
            <button class="btn ghost" id="btn-signout">Sign Out</button>
        </div>
    </header>

    <main class="hero">
        <div class="glass card">
            <h1>Detect Fake News with Confidence</h1>
            <p>Enter a news article URL to assess its credibility. We detect the language, translate if needed, and classify the headline.</p>
            <form id="news-form" class="form-inline">
                <input type="url" id="url-input" placeholder="Enter news URL" required>
                <button type="submit" class="btn accent">Analyze</button>
            </form>
            <div id="results" class="results">
                <p id="headline"></p>
                <p id="result"></p>
                <p id="error" class="error"></p>
                <div id="loading" class="loading" style="display:none;">
                    <span class="spinner"></span>
                    <span>Analyzingâ€¦</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Sign In Modal -->
    <div class="modal" id="modal-signin" style="display:none;">
        <div class="modal-content">
            <h2>Sign In</h2>
            <form id="form-signin">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn primary">Sign In</button>
                <button type="button" class="btn ghost" data-close="#modal-signin">Cancel</button>
            </form>
            <p class="error" id="signin-error"></p>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="modal" id="modal-signup" style="display:none;">
        <div class="modal-content">
            <h2>Create Account</h2>
            <form id="form-signup">
                <input type="text" name="full_name" placeholder="Full name" required>
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn primary">Create Account</button>
                <button type="button" class="btn ghost" data-close="#modal-signup">Cancel</button>
            </form>
            <p class="error" id="signup-error"></p>
        </div>
    </div>

    <script>
        async function fetchMe() {
            const res = await fetch('/api/me');
            const me = await res.json();
            const actions = document.getElementById('nav-actions');
            const user = document.getElementById('nav-user');
            if (me && me.username) {
                document.getElementById('nav-fullname').textContent = me.full_name + ' (' + me.username + ')';
                actions.style.display = 'none';
                user.style.display = 'flex';
            } else {
                actions.style.display = 'flex';
                user.style.display = 'none';
            }
        }

        function openModal(id) { document.querySelector(id).style.display = 'flex'; }
        function closeModal(id) { document.querySelector(id).style.display = 'none'; }

        document.getElementById('btn-signin').addEventListener('click', () => openModal('#modal-signin'));
        document.getElementById('btn-signup').addEventListener('click', () => openModal('#modal-signup'));
        document.querySelectorAll('[data-close]').forEach(el => {
            el.addEventListener('click', () => closeModal(el.getAttribute('data-close')));
        });

        document.getElementById('btn-signout').addEventListener('click', async () => {
            await fetch('/api/signout', { method: 'POST' });
            await fetchMe();
        });

        document.getElementById('form-signin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const body = new URLSearchParams(new FormData(form));
            const res = await fetch('/api/signin', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
            const data = await res.json();
            if (data.error) {
                document.getElementById('signin-error').textContent = data.error;
            } else {
                document.getElementById('signin-error').textContent = '';
                closeModal('#modal-signin');
                await fetchMe();
            }
        });

        document.getElementById('form-signup').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const body = new URLSearchParams(new FormData(form));
            const res = await fetch('/api/signup', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
            const data = await res.json();
            if (data.error) {
                document.getElementById('signup-error').textContent = data.error;
            } else {
                document.getElementById('signup-error').textContent = '';
                closeModal('#modal-signup');
                await fetchMe();
            }
        });

        const form = document.getElementById('news-form');
        const analyzeBtn = form.querySelector('button[type="submit"]');
        const loadingEl = document.getElementById('loading');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('url-input').value;

            // reset and show loading
            document.getElementById('headline').textContent = '';
            document.getElementById('result').textContent = '';
            document.getElementById('error').textContent = '';
            loadingEl.style.display = 'flex';
            analyzeBtn.disabled = true;

            const delay = new Promise(res => setTimeout(res, 2000));
            try {
                const fetchPromise = fetch('/detect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ url })
                }).then(r => r.json());

                const [data] = await Promise.all([fetchPromise, delay]);

                if (data.error) {
                    document.getElementById('error').textContent = data.error;
                } else {
                    document.getElementById('headline').textContent = 'Headline: ' + data.headline;
                    document.getElementById('result').textContent = 'Result: ' + data.result;
                }
            } catch (err) {
                document.getElementById('error').textContent = 'Connection failed';
            } finally {
                loadingEl.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });

        fetchMe();
    </script>
</body>
</html>